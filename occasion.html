<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelegenheid - Gift Name Shuffler</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Occasion page specific styles */
        .occasion-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
        }

        .occasion-header h2 {
            border: none;
            color: white;
            margin: 0 0 10px 0;
        }

        .occasion-header .occasion-date {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .occasion-header .occasion-admin {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .participant-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .participant-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .participant-list li:hover {
            background: #e9ecef;
        }

        .participant-name {
            font-weight: 500;
        }

        .participant-webid {
            font-size: 0.85rem;
            color: #666;
            word-break: break-all;
        }

        .participant-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #d4edda;
            color: #155724;
        }

        .registration-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .registration-success h3 {
            color: #155724;
            margin-top: 0;
        }

        .share-link-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .copy-success {
            color: #28a745;
            font-weight: bold;
            margin-left: 10px;
            display: none;
        }

        .create-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }

        .create-form h3 {
            margin-top: 0;
            color: #333;
        }

        .create-form .form-row {
            margin-bottom: 15px;
        }

        .create-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .create-form input[type="text"],
        .create-form input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .admin-actions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .admin-actions h4 {
            margin-top: 0;
            color: #856404;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .no-occasion {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>Gift Name Shuffler</h1>
        <p>Gelegenheid beheren</p>
    </header>

    <main>
        <a href="index.html" class="back-link">&larr; Terug naar overzicht</a>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading">Laden...</div>
        </div>

        <!-- Solid login section -->
        <section id="solid-section" class="card">
            <h2>Solid Account</h2>
            <p class="info-text">Log in met je Solid Pod om gelegenheden te beheren of je in te schrijven.</p>

            <div id="solid-login">
                <div class="form-row">
                    <select id="solid-provider">
                        <option value="">-- Kies provider --</option>
                    </select>
                    <button onclick="loginToSolid()">Inloggen met Solid</button>
                </div>
            </div>

            <div id="solid-profile" style="display: none;">
                <p>Ingelogd als: <strong id="solid-webid" title=""></strong></p>
                <button onclick="logoutFromSolid()">Uitloggen</button>
            </div>
        </section>

        <!-- My occasions list (shown when logged in and no occasion in URL) -->
        <section id="my-occasions-section" class="card" style="display: none;">
            <h2>Mijn Gelegenheden</h2>
            <div id="my-occasions-list">
                <p><em>Laden...</em></p>
            </div>
        </section>

        <!-- Create new occasion (shown when no occasion in URL and logged in) -->
        <section id="create-section" class="card" style="display: none;">
            <h2>Nieuwe Gelegenheid Aanmaken</h2>
            <div class="create-form">
                <div class="form-row">
                    <label for="occasion-name">Naam van de gelegenheid</label>
                    <input type="text" id="occasion-name" placeholder="bijv. Kerstfeest 2025">
                </div>
                <div class="form-row">
                    <label for="occasion-date">Datum (optioneel)</label>
                    <input type="date" id="occasion-date">
                </div>
                <button onclick="createOccasion()" class="primary-btn">Aanmaken</button>
            </div>
        </section>

        <!-- View occasion (shown when occasion URL is provided) -->
        <section id="occasion-section" class="card" style="display: none;">
            <div id="occasion-header" class="occasion-header">
                <h2 id="occasion-title">Laden...</h2>
                <div id="occasion-date-display" class="occasion-date"></div>
                <div id="occasion-admin-display" class="occasion-admin"></div>
            </div>

            <!-- Registration status for current user -->
            <div id="registration-status"></div>

            <!-- Register button (for non-admin participants) -->
            <div id="register-section" style="display: none;">
                <p>Schrijf je in voor deze gelegenheid zodat anderen je wishlist kunnen zien.</p>
                <button onclick="registerForOccasion()" class="primary-btn">Schrijf me in</button>
            </div>

            <!-- Participant list (visible to admin) -->
            <div id="participants-section" style="display: none;">
                <h3>Ingeschreven Deelnemers</h3>
                <div id="participants-list-container">
                    <p><em>Laden...</em></p>
                </div>
            </div>

            <!-- Share link (visible to admin) -->
            <div id="share-section" class="admin-actions" style="display: none;">
                <h4>Uitnodigingslink</h4>
                <p>Deel deze link met deelnemers om ze uit te nodigen:</p>
                <div id="share-link-box" class="share-link-box"></div>
                <button onclick="copyShareLink()" class="primary-btn">Kopieer link</button>
                <span id="copy-success" class="copy-success">Gekopieerd!</span>
            </div>
        </section>

        <!-- No occasion message -->
        <section id="no-occasion-section" class="card" style="display: none;">
            <div class="no-occasion">
                <h3>Geen gelegenheid gevonden</h3>
                <p>Log in om een nieuwe gelegenheid aan te maken, of open een uitnodigingslink.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>Gift Name Shuffler &mdash; Een eenvoudige app voor cadeautjes uitwisseling.</p>
    </footer>

    <!-- CRITICAL: Capture occasion URL BEFORE any module scripts run (they are deferred) -->
    <script>
        (function() {
            const occasionUrl = new URLSearchParams(window.location.search).get('occasion');
            if (occasionUrl) {
                sessionStorage.setItem('current_occasion_url', occasionUrl);
                console.log('[SYNC] Captured occasion URL:', occasionUrl);
            } else if (!window.location.search.includes('code=')) {
                // Clear stored occasion if visiting base page (not OIDC callback)
                sessionStorage.removeItem('current_occasion_url');
            }
        })();
    </script>
    <script type="module" src="solid.js"></script>
    <script type="module">
        // ===========================================
        // OCCASION PAGE LOGIC
        // ===========================================

        // Current occasion data
        let currentOccasion = null;
        let isAdmin = false;
        let occasionLoaded = false;
        let isLoadingOccasion = false;

        /**
         * Get occasion URL - uses sessionStorage (set by sync script) or current URL
         */
        function getOccasionUrl() {
            // First check sessionStorage (set by sync script, survives redirects)
            const stored = sessionStorage.getItem('current_occasion_url');
            if (stored) {
                return stored;
            }
            // Fall back to current URL
            const params = new URLSearchParams(window.location.search);
            return params.get('occasion');
        }

        /**
         * Show loading overlay
         */
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        /**
         * Hide loading overlay
         */
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        /**
         * Show error message
         */
        function showError(message) {
            const container = document.getElementById('registration-status');
            container.innerHTML = `<div class="error-box">${escapeHtml(message)}</div>`;
        }

        /**
         * Escape HTML
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Create a new occasion in the user's Pod
         */
        async function createOccasion() {
            const nameInput = document.getElementById('occasion-name');
            const dateInput = document.getElementById('occasion-date');

            const name = nameInput.value.trim();
            if (!name) {
                alert('Vul een naam in voor de gelegenheid.');
                return;
            }

            const isLoggedIn = typeof isSolidLoggedIn === 'function' && isSolidLoggedIn();
            if (!isLoggedIn) {
                alert('Je moet eerst inloggen met Solid.');
                return;
            }

            showLoading();

            try {
                const webId = getCurrentWebId();
                const occasionId = name.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');

                const result = await createOccasionInPod({
                    id: occasionId,
                    name: name,
                    date: dateInput.value || null,
                    adminWebId: webId
                });

                // Redirect to the new occasion
                window.location.href = `occasion.html?occasion=${encodeURIComponent(result.occasionUrl)}`;
            } catch (error) {
                console.error('Error creating occasion:', error);
                alert('Kon gelegenheid niet aanmaken: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Register current user for the occasion
         */
        async function registerForOccasion() {
            const isLoggedIn = typeof isSolidLoggedIn === 'function' && isSolidLoggedIn();
            if (!isLoggedIn) {
                alert('Je moet eerst inloggen met Solid.');
                return;
            }

            if (!currentOccasion) {
                alert('Geen gelegenheid geladen.');
                return;
            }

            showLoading();

            try {
                const webId = getCurrentWebId();
                await registerParticipant(currentOccasion.registrationsUrl, webId);

                // Show success message
                const statusContainer = document.getElementById('registration-status');
                statusContainer.innerHTML = `
                    <div class="registration-success">
                        <h3>Ingeschreven!</h3>
                        <p>Je bent nu ingeschreven voor ${escapeHtml(currentOccasion.name)}.</p>
                        <p>Anderen kunnen nu je wishlist zien. Vergeet niet om je <a href="reveal.html">wishlist</a> bij te werken!</p>
                    </div>
                `;

                // Hide register button
                document.getElementById('register-section').style.display = 'none';

                // Refresh participants if admin
                if (isAdmin) {
                    await loadParticipants();
                }
            } catch (error) {
                console.error('Error registering:', error);
                showError('Kon niet inschrijven: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Load occasion data from URL
         */
        async function loadOccasion(occasionUrl) {
            // Prevent multiple simultaneous loads
            if (isLoadingOccasion) return;
            isLoadingOccasion = true;

            showLoading();

            try {
                const occasion = await fetchOccasion(occasionUrl);
                occasionLoaded = true;
                currentOccasion = occasion;

                // Update header
                document.getElementById('occasion-title').textContent = occasion.name;
                if (occasion.date) {
                    document.getElementById('occasion-date-display').textContent = occasion.date;
                }
                document.getElementById('occasion-admin-display').textContent =
                    `Georganiseerd door: ${occasion.adminWebId.replace('https://', '').replace('/profile/card#me', '')}`;

                // Check if current user is admin
                const currentWebId = typeof getCurrentWebId === 'function' ? getCurrentWebId() : null;
                isAdmin = currentWebId && currentWebId === occasion.adminWebId;

                // Show appropriate sections
                document.getElementById('occasion-section').style.display = 'block';

                if (isAdmin) {
                    // Admin view: show participants and share link
                    document.getElementById('participants-section').style.display = 'block';
                    document.getElementById('share-section').style.display = 'block';
                    document.getElementById('share-link-box').textContent =
                        window.location.origin + window.location.pathname + '?occasion=' + encodeURIComponent(occasionUrl);
                    await loadParticipants();
                } else if (currentWebId) {
                    // Logged in participant: check if already registered
                    const participants = await fetchParticipants(occasion.registrationsUrl);
                    const isRegistered = participants.some(p => p.webId === currentWebId);

                    if (isRegistered) {
                        document.getElementById('registration-status').innerHTML = `
                            <div class="registration-success">
                                <h3>Je bent ingeschreven!</h3>
                                <p>Je neemt deel aan ${escapeHtml(occasion.name)}.</p>
                            </div>
                        `;
                    } else {
                        document.getElementById('register-section').style.display = 'block';
                    }
                } else {
                    // Not logged in: show register section with login prompt
                    document.getElementById('register-section').style.display = 'block';
                    document.getElementById('register-section').innerHTML = `
                        <p>Log in met je Solid account om je in te schrijven voor deze gelegenheid.</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading occasion:', error);
                showError('Kon gelegenheid niet laden: ' + error.message);
            } finally {
                hideLoading();
                isLoadingOccasion = false;
            }
        }

        /**
         * Load participants list (admin only)
         */
        async function loadParticipants() {
            if (!currentOccasion) return;

            const container = document.getElementById('participants-list-container');
            container.innerHTML = '<p><em>Deelnemers laden...</em></p>';

            try {
                const participants = await fetchParticipants(currentOccasion.registrationsUrl);

                if (participants.length === 0) {
                    container.innerHTML = '<p><em>Nog geen inschrijvingen.</em></p>';
                    return;
                }

                container.innerHTML = `
                    <ul class="participant-list">
                        ${participants.map(p => `
                            <li>
                                <div>
                                    <div class="participant-name">${escapeHtml(p.name || 'Onbekend')}</div>
                                    <div class="participant-webid">${escapeHtml(p.webId)}</div>
                                </div>
                                <span class="participant-status">Ingeschreven</span>
                            </li>
                        `).join('')}
                    </ul>
                    <p style="margin-top: 15px; color: #666;">
                        <strong>${participants.length}</strong> deelnemer(s) ingeschreven
                    </p>
                `;
            } catch (error) {
                console.error('Error loading participants:', error);
                container.innerHTML = '<p class="error-box">Kon deelnemers niet laden.</p>';
            }
        }

        /**
         * Copy share link to clipboard
         */
        function copyShareLink() {
            const linkBox = document.getElementById('share-link-box');
            const successSpan = document.getElementById('copy-success');

            navigator.clipboard.writeText(linkBox.textContent).then(() => {
                successSpan.style.display = 'inline';
                setTimeout(() => {
                    successSpan.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Kon link niet kopiÃ«ren. Selecteer de link handmatig.');
            });
        }

        /**
         * Load user's existing occasions from their Pod
         */
        async function loadMyOccasions() {
            const container = document.getElementById('my-occasions-list');
            if (!container) return;

            const webId = typeof getCurrentWebId === 'function' ? getCurrentWebId() : null;
            if (!webId) {
                container.innerHTML = '<p><em>Log in om je gelegenheden te zien.</em></p>';
                return;
            }

            try {
                const podBase = webId.split('/profile/')[0];
                const occasionsContainerUrl = `${podBase}/public/giftshuffler/occasions/`;

                const session = typeof getSolidSession === 'function' ? getSolidSession() : null;
                const fetchFn = session && session.info.isLoggedIn ? session.fetch.bind(session) : fetch;

                const response = await fetchFn(occasionsContainerUrl, {
                    headers: { 'Accept': 'text/turtle' }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        container.innerHTML = '<p><em>Je hebt nog geen gelegenheden aangemaakt.</em></p>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const turtle = await response.text();
                console.log('Occasions container turtle:', turtle);

                // Find all containers (occasions) - look for ldp:contains
                // Handle both direct matches and comma-separated lists
                const occasions = [];

                // First, find all ldp:contains sections (may have multiple items separated by commas)
                const containsRegex = /ldp:contains\s+([^;.]+)/g;
                let containsMatch;

                while ((containsMatch = containsRegex.exec(turtle)) !== null) {
                    const containsSection = containsMatch[1];
                    // Extract all <url> patterns from this section
                    const urlRegex = /<([^>]+)>/g;
                    let urlMatch;

                    while ((urlMatch = urlRegex.exec(containsSection)) !== null) {
                        const itemUrl = urlMatch[1];
                        // Folders end with / - this is more reliable than checking for .
                        if (itemUrl.endsWith('/')) {
                            const fullUrl = itemUrl.startsWith('http') ? itemUrl : occasionsContainerUrl + itemUrl;
                            const name = itemUrl.replace(/\/$/, '').split('/').pop();
                            occasions.push({
                                name: name,
                                url: fullUrl + 'occasion.ttl'
                            });
                        }
                    }
                }

                console.log('Found occasions:', occasions);

                if (occasions.length === 0) {
                    container.innerHTML = '<p><em>Je hebt nog geen gelegenheden aangemaakt.</em></p>';
                    return;
                }

                container.innerHTML = `
                    <ul class="participant-list">
                        ${occasions.map(o => `
                            <li>
                                <span class="participant-name">${escapeHtml(o.name)}</span>
                                <a href="occasion.html?occasion=${encodeURIComponent(o.url)}" class="button primary-btn" style="text-decoration: none; padding: 5px 10px;">Bekijk</a>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading occasions:', error);
                container.innerHTML = '<p><em>Kon gelegenheden niet laden.</em></p>';
            }
        }

        let myOccasionsLoaded = false;

        /**
         * Update UI based on login state
         */
        function updateUI() {
            const isLoggedIn = typeof isSolidLoggedIn === 'function' && isSolidLoggedIn();
            const occasionUrl = getOccasionUrl();

            if (occasionUrl) {
                // Viewing an occasion
                document.getElementById('create-section').style.display = 'none';
                document.getElementById('no-occasion-section').style.display = 'none';
                document.getElementById('my-occasions-section').style.display = 'none';
                // Only load once
                if (!occasionLoaded && !isLoadingOccasion) {
                    loadOccasion(occasionUrl);
                }
            } else if (isLoggedIn) {
                // No occasion, but logged in - show create form and my occasions
                document.getElementById('create-section').style.display = 'block';
                document.getElementById('my-occasions-section').style.display = 'block';
                document.getElementById('no-occasion-section').style.display = 'none';
                document.getElementById('occasion-section').style.display = 'none';
                // Load my occasions once
                if (!myOccasionsLoaded) {
                    myOccasionsLoaded = true;
                    loadMyOccasions();
                }
            } else {
                // Not logged in, no occasion
                document.getElementById('create-section').style.display = 'none';
                document.getElementById('my-occasions-section').style.display = 'none';
                document.getElementById('no-occasion-section').style.display = 'block';
                document.getElementById('occasion-section').style.display = 'none';
            }
        }

        // Expose functions to window
        window.createOccasion = createOccasion;
        window.registerForOccasion = registerForOccasion;
        window.copyShareLink = copyShareLink;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Initial UI update
            setTimeout(updateUI, 500);

            // Periodically check for login state changes
            setInterval(updateUI, 3000);
        });
    </script>
</body>
</html>
